module ExamplesTest.Spec where

import Prelude

import Data.Maybe (Maybe(..))
import Data.String as String
import Effect (Effect)
import Type.Function (type (#))
import Type.Proxy (Proxy(..))
import Yoga.HTTP.API.Path (Path, Lit, Var)
import Yoga.HTTP.API.Route (GET, POST, Route, Request, buildOpenAPISpec)
import Yoga.HTTP.API.Route.Encoding (JSON)
import Yoga.HTTP.API.Route.OpenAPIMetadata (Examples, ExampleValue, ExampleWithSummary, ExampleObject, example, examples)
import Yoga.JSON (writeJSON)
import ViTest (ViTest, describe, test)
import ViTest.Expect (expectToBe)

testExamplesMetadataExtraction :: Effect ViTest
testExamplesMetadataExtraction = describe "Examples Metadata - Type-level extraction" do
  _ <- test "extracts Nothing for type without Examples" do
    let
      p = Proxy :: Proxy Int
      result = examples p
    expectToBe true (result == Nothing)

  _ <- test "extracts single example from Examples wrapper" do
    let
      p = Proxy :: Proxy (Int # Examples (basic :: ExampleValue "42"))
      result = examples p
    expectToBe true (result /= Nothing)

  test "extracts multiple examples from Examples wrapper" do
    let
      p = Proxy :: Proxy (Int # Examples (basic :: ExampleValue "42", advanced :: ExampleValue "100"))
      result = examples p
    expectToBe true (result /= Nothing)

type TestAPIWithPathExamples =
  { getUser :: Route GET (Path (Lit "users" / Var "userId" (Int # Examples (basic :: ExampleValue "123", premium :: ExampleWithSummary "456" "Premium user")))) (Request {}) (ok :: { body :: { id :: Int, name :: String } })
  }

testExamplesInParameters :: Effect ViTest
testExamplesInParameters = describe "Examples in Parameters" do
  test "generates examples for path parameter" do
    let
      spec = buildOpenAPISpec @TestAPIWithPathExamples
        { title: "Test API"
        , version: "1.0.0"
        , description: Nothing
        , contact: Nothing
        , license: Nothing
        }
      json = writeJSON spec
    expectToBe true (String.contains (String.Pattern "users") json)

type User =
  { id :: Int # Examples (basic :: ExampleValue "123", admin :: ExampleValue "1")
  , name :: String # Examples (basic :: ExampleValue "\"John Doe\"", admin :: ExampleValue "\"Admin User\"")
  }

type TestAPIWithRequestBodyExamples =
  { createUser :: Route POST (Path (Lit "users")) (Request { body :: JSON User }) (ok :: { body :: { id :: Int } })
  }

testExamplesInRequestBody :: Effect ViTest
testExamplesInRequestBody = describe "Examples in Request Body" do
  test "generates examples for JSON request body fields" do
    let
      spec = buildOpenAPISpec @TestAPIWithRequestBodyExamples
        { title: "Test API"
        , version: "1.0.0"
        , description: Nothing
        , contact: Nothing
        , license: Nothing
        }
      json = writeJSON spec
    expectToBe true (String.contains (String.Pattern "users") json)

type TestAPIWithComplexExamples =
  { getItem :: Route GET (Path (Lit "items" / Var "itemId" (Int # Examples (basic :: ExampleWithSummary "42" "A basic item", special :: ExampleObject "999" "Special item" "A very special item" "")))) (Request {}) (ok :: { body :: { id :: Int } })
  }

testExamplesWithSummary :: Effect ViTest
testExamplesWithSummary = describe "Examples with Summary" do
  test "includes summary field in example object" do
    let
      spec = buildOpenAPISpec @TestAPIWithComplexExamples
        { title: "Test API"
        , version: "1.0.0"
        , description: Nothing
        , contact: Nothing
        , license: Nothing
        }
      json = writeJSON spec
    expectToBe true (String.contains (String.Pattern "items") json)

testExamplesBackwardCompatibility :: Effect ViTest
testExamplesBackwardCompatibility = describe "Backward Compatibility - Single Example" do
  _ <- test "single Example still works" do
    let
      p = Proxy :: Proxy (Int # Yoga.HTTP.API.Route.OpenAPIMetadata.Example "42")
      result = example p
    expectToBe true (result == Just "42")

  test "Example and Examples can coexist" do
    let
      p = Proxy :: Proxy (Int # Yoga.HTTP.API.Route.OpenAPIMetadata.Example "42" # Examples (alt1 :: ExampleValue "100", alt2 :: ExampleValue "200"))
      exResult = example p
      exsResult = examples p
    expectToBe true (exResult == Just "42")
    expectToBe true (exsResult /= Nothing)

type TestAPIWithQueryExamples =
  { searchItems :: Route GET (Path (Lit "items")) (Request { query :: { limit :: Int # Examples (small :: ExampleValue "10", large :: ExampleValue "100") } }) (ok :: { body :: { items :: Array String } })
  }

testExamplesInQueryParams :: Effect ViTest
testExamplesInQueryParams = describe "Examples in Query Parameters" do
  test "generates examples for query parameter" do
    let
      spec = buildOpenAPISpec @TestAPIWithQueryExamples
        { title: "Test API"
        , version: "1.0.0"
        , description: Nothing
        , contact: Nothing
        , license: Nothing
        }
      json = writeJSON spec
    expectToBe true (String.contains (String.Pattern "items") json)

type TestAPIWithExternalExample =
  { getResource :: Route GET (Path (Lit "resource" / Var "id" (String # Examples (inline :: ExampleObject "abc123" "Inline example" "An example with inline value" "", external :: ExampleObject "" "External example" "An example from external URL" "https://example.com/resource.json")))) (Request {}) (ok :: { body :: { data :: String } })
  }

testComplexExampleObject :: Effect ViTest
testComplexExampleObject = describe "Complex Example Objects" do
  test "ExampleObject with all fields" do
    let
      spec = buildOpenAPISpec @TestAPIWithExternalExample
        { title: "Test API"
        , version: "1.0.0"
        , description: Nothing
        , contact: Nothing
        , license: Nothing
        }
      json = writeJSON spec
    expectToBe true (String.contains (String.Pattern "resource") json)
