module LinksTest.Spec where

import Prelude

import Data.String as String
import Effect (Effect)
import Yoga.HTTP.API.Path (Path, Lit, type (:), type (/))
import Yoga.HTTP.API.Route (GET, POST, DELETE, Route, Request, JSON, Link, buildOpenAPISpec)
import Yoga.JSON (writeJSON)
import ViTest (ViTest, describe, test)
import ViTest.Expect (expectToBe)

--------------------------------------------------------------------------------
-- Types
--------------------------------------------------------------------------------

type User = { id :: Int, name :: String, email :: String }
type UserList = { users :: Array User, total :: Int }

--------------------------------------------------------------------------------
-- API with Links
--------------------------------------------------------------------------------

type UsersAPI =
  { listUsers ::
      Route GET "users"
        (Request {})
        ( ok ::
            { body :: UserList }
              # Link "getUser" "getUserById" { userId: "$response.body#/users/0/id" }
        )
  , getUser ::
      Route GET ("users" / "id" : Int)
        (Request {})
        ( ok ::
            { body :: User }
              # Link "deleteUser" "deleteUserById" { userId: "$response.body#/id" }
              # Link "updateUser" "updateUserById" { userId: "$response.body#/id" }
        )
  , createUser ::
      Route POST "users"
        (Request { body :: JSON User })
        ( created ::
            { body :: User, headers :: { "Location" :: String } }
              # Link "getUser" "getUserById" { userId: "$response.body#/id" }
        )
  , updateUser ::
      Route POST ("users" / "id" : Int)
        (Request { body :: JSON User })
        ( ok ::
            { body :: User }
        )
  , deleteUser ::
      Route DELETE ("users" / "id" : Int)
        (Request {})
        ( noContent :: {} )
  }

--------------------------------------------------------------------------------
-- Tests
--------------------------------------------------------------------------------

testLinksInResponse :: Effect ViTest
testLinksInResponse = describe "OpenAPI Links" do
  _ <- test "generates links in response object" do
    let
      spec = buildOpenAPISpec @UsersAPI
        { title: "Users API"
        , version: "1.0.0"
        , description: Nothing
        , contact: Nothing
        , license: Nothing
        }
      json = writeJSON spec

    -- Check that links are present
    expectToBe true (String.contains (String.Pattern "\"links\"") json)
    expectToBe true (String.contains (String.Pattern "\"getUser\"") json)
    expectToBe true (String.contains (String.Pattern "\"deleteUser\"") json)

  _ <- test "includes operationId in link" do
    let
      spec = buildOpenAPISpec @UsersAPI
        { title: "Users API"
        , version: "1.0.0"
        , description: Nothing
        , contact: Nothing
        , license: Nothing
        }
      json = writeJSON spec

    expectToBe true (String.contains (String.Pattern "\"operationId\"") json)
    expectToBe true (String.contains (String.Pattern "\"getUserById\"") json)
    expectToBe true (String.contains (String.Pattern "\"deleteUserById\"") json)

  _ <- test "includes parameters with runtime expressions" do
    let
      spec = buildOpenAPISpec @UsersAPI
        { title: "Users API"
        , version: "1.0.0"
        , description: Nothing
        , contact: Nothing
        , license: Nothing
        }
      json = writeJSON spec

    expectToBe true (String.contains (String.Pattern "\"parameters\"") json)
    expectToBe true (String.contains (String.Pattern "\"userId\"") json)
    expectToBe true (String.contains (String.Pattern "$response.body#/id") json)

  _ <- test "supports multiple links on same response" do
    let
      spec = buildOpenAPISpec @UsersAPI
        { title: "Users API"
        , version: "1.0.0"
        , description: Nothing
        , contact: Nothing
        , license: Nothing
        }
      json = writeJSON spec

    -- getUser response has both deleteUser and updateUser links
    expectToBe true (String.contains (String.Pattern "\"deleteUser\"") json)
    expectToBe true (String.contains (String.Pattern "\"updateUser\"") json)
    expectToBe true (String.contains (String.Pattern "\"updateUserById\"") json)

  test "supports links on responses with headers" do
    let
      spec = buildOpenAPISpec @UsersAPI
        { title: "Users API"
        , version: "1.0.0"
        , description: Nothing
        , contact: Nothing
        , license: Nothing
        }
      json = writeJSON spec

    -- created response has both Location header and getUser link
    expectToBe true (String.contains (String.Pattern "\"Location\"") json)
    expectToBe true (String.contains (String.Pattern "\"links\"") json)

--------------------------------------------------------------------------------
-- HATEOAS Example
--------------------------------------------------------------------------------

type BlogAPI =
  { getPosts ::
      Route GET "posts"
        (Request {})
        ( ok ::
            { body :: Array { id :: Int, title :: String } }
              # Link "getPost" "getPostById" { postId: "$response.body#/0/id" }
        )
  , getPost ::
      Route GET ("posts" / "id" : Int)
        (Request {})
        ( ok ::
            { body :: { id :: Int, title :: String, content :: String, authorId :: Int } }
              # Link "getAuthor" "getAuthorById" { authorId: "$response.body#/authorId" }
              # Link "updatePost" "updatePostById" { postId: "$response.body#/id" }
              # Link "deletePost" "deletePostById" { postId: "$response.body#/id" }
        )
  , getAuthor ::
      Route GET ("authors" / "id" : Int)
        (Request {})
        ( ok :: { body :: { id :: Int, name :: String } } )
  , updatePost ::
      Route POST ("posts" / "id" : Int)
        (Request { body :: JSON { title :: String, content :: String } })
        ( ok :: { body :: { id :: Int, title :: String, content :: String } } )
  , deletePost ::
      Route DELETE ("posts" / "id" : Int)
        (Request {})
        ( noContent :: {} )
  }

testHATEOASLinks :: Effect ViTest
testHATEOASLinks = describe "HATEOAS Links" do
  _ <- test "demonstrates discoverable API with links" do
    let
      spec = buildOpenAPISpec @BlogAPI
        { title: "Blog API"
        , version: "1.0.0"
        , description: Nothing
        , contact: Nothing
        , license: Nothing
        }
      json = writeJSON spec

    -- Verify complete HATEOAS chain
    expectToBe true (String.contains (String.Pattern "\"getPost\"") json)
    expectToBe true (String.contains (String.Pattern "\"getAuthor\"") json)
    expectToBe true (String.contains (String.Pattern "\"updatePost\"") json)
    expectToBe true (String.contains (String.Pattern "\"deletePost\"") json)

  test "supports nested JSON pointer expressions" do
    let
      spec = buildOpenAPISpec @BlogAPI
        { title: "Blog API"
        , version: "1.0.0"
        , description: Nothing
        , contact: Nothing
        , license: Nothing
        }
      json = writeJSON spec

    expectToBe true (String.contains (String.Pattern "$response.body#/authorId") json)
    expectToBe true (String.contains (String.Pattern "$response.body#/0/id") json)
